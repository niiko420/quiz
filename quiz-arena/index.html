<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QUIZ ARENA</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root {
    --neon-cyan: #00f5ff;
    --neon-pink: #ff006e;
    --neon-yellow: #ffbe0b;
    --neon-green: #06d6a0;
    --dark: #050510;
    --panel: rgba(0, 245, 255, 0.04);
    --border: rgba(0, 245, 255, 0.2);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark);
    color: white;
    font-family: 'Share Tech Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,245,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,245,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.12) 2px, rgba(0,0,0,0.12) 4px);
    pointer-events: none;
    z-index: 1;
  }

  .screen {
    position: relative;
    z-index: 2;
    display: none;
    min-height: 100vh;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 20px;
  }
  .screen.active { display: flex; }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-size: clamp(2.5rem, 8vw, 5rem);
    font-weight: 900;
    letter-spacing: 0.1em;
    color: var(--neon-cyan);
    text-shadow: 0 0 10px var(--neon-cyan), 0 0 30px var(--neon-cyan), 0 0 80px rgba(0,245,255,0.4);
    animation: flicker 4s infinite;
    text-align: center;
  }
  .logo span { color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink), 0 0 30px var(--neon-pink), 0 0 80px rgba(255,0,110,0.4); }
  .logo-sm { font-size: 2rem; margin-bottom: 20px; }

  @keyframes flicker {
    0%, 95%, 100% { opacity: 1; }
    96% { opacity: 0.8; }
    97% { opacity: 1; }
    98% { opacity: 0.6; }
    99% { opacity: 1; }
  }

  .tagline {
    color: rgba(255,255,255,0.4);
    font-size: 0.85rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin: 8px 0 40px;
    text-align: center;
  }

  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 30px;
    width: 100%;
    max-width: 560px;
    position: relative;
  }
  .panel::before {
    content: '';
    position: absolute;
    top: -1px; left: 20px; right: 20px; height: 1px;
    background: var(--neon-cyan);
    box-shadow: 0 0 10px var(--neon-cyan);
  }

  .panel-title {
    font-family: 'Orbitron', sans-serif;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    color: var(--neon-cyan);
    opacity: 0.7;
    text-transform: uppercase;
    margin-bottom: 16px;
  }

  .categories {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .cat-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 4px;
    color: white;
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.85rem;
    padding: 16px 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }
  .cat-btn .cat-icon { font-size: 1.6rem; }
  .cat-btn .cat-name { font-size: 0.7rem; letter-spacing: 0.1em; text-transform: uppercase; }
  .cat-btn:hover { border-color: var(--cat-color, var(--neon-cyan)); color: var(--cat-color, var(--neon-cyan)); background: rgba(0,245,255,0.04); }
  .cat-btn.selected { border-color: var(--cat-color, var(--neon-cyan)); background: rgba(0,245,255,0.08); color: var(--cat-color, var(--neon-cyan)); box-shadow: 0 0 20px rgba(0,245,255,0.15); }

  .btn {
    background: transparent;
    border: 1px solid var(--neon-cyan);
    color: var(--neon-cyan);
    font-family: 'Orbitron', sans-serif;
    font-size: 0.8rem;
    letter-spacing: 0.2em;
    padding: 14px 30px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .btn::before { content: ''; position: absolute; inset: 0; background: var(--neon-cyan); transform: scaleX(0); transform-origin: left; transition: transform 0.2s; z-index: -1; }
  .btn:hover { color: var(--dark); box-shadow: 0 0 30px rgba(0,245,255,0.4); }
  .btn:hover::before { transform: scaleX(1); }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .btn:disabled:hover { color: var(--neon-cyan); }
  .btn:disabled:hover::before { transform: scaleX(0); }
  .btn-pink { border-color: var(--neon-pink); color: var(--neon-pink); }
  .btn-pink::before { background: var(--neon-pink); }
  .btn-pink:hover { color: white; box-shadow: 0 0 30px rgba(255,0,110,0.4); }

  .input-field {
    background: transparent;
    border: 1px solid var(--border);
    color: white;
    font-family: 'Share Tech Mono', monospace;
    font-size: 1rem;
    padding: 12px 16px;
    width: 100%;
    outline: none;
    border-radius: 3px;
    transition: border-color 0.2s;
    margin-bottom: 16px;
  }
  .input-field:focus { border-color: var(--neon-cyan); box-shadow: 0 0 10px rgba(0,245,255,0.15); }

  /* Searching */
  .waiting-anim { display: flex; gap: 8px; margin: 20px 0; justify-content: center; }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--neon-cyan); animation: pulse-dot 1.4s ease-in-out infinite; box-shadow: 0 0 10px var(--neon-cyan); }
  .dot:nth-child(2) { animation-delay: 0.2s; }
  .dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes pulse-dot { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }

  .loading-text { font-family: 'Orbitron', sans-serif; font-size: 0.75rem; letter-spacing: 0.3em; color: var(--neon-cyan); animation: blink 1s step-end infinite; }
  @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

  /* VS */
  .vs-container { display: flex; align-items: center; gap: 20px; margin: 20px 0; }
  .player-card { flex: 1; background: var(--panel); border: 1px solid var(--border); border-radius: 4px; padding: 20px; text-align: center; }
  .player-avatar { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; border: 2px solid var(--neon-cyan); box-shadow: 0 0 15px rgba(0,245,255,0.3); }
  .player-card.opponent .player-avatar { border-color: var(--neon-pink); box-shadow: 0 0 15px rgba(255,0,110,0.3); }
  .player-name { font-family: 'Orbitron', sans-serif; font-size: 0.7rem; letter-spacing: 0.1em; }
  .vs-text { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; font-weight: 900; color: var(--neon-yellow); text-shadow: 0 0 20px var(--neon-yellow); }

  /* Quiz */
  .score-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
  .score-box { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: 700; }
  .score-box.you { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }
  .score-box.opp { color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); }
  .q-counter { font-size: 0.75rem; color: rgba(255,255,255,0.4); letter-spacing: 0.2em; }

  .timer-wrap { position: relative; margin-bottom: 20px; }
  .timer-bar { height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; }
  .timer-fill { height: 100%; background: var(--neon-cyan); box-shadow: 0 0 8px var(--neon-cyan); transition: width 1s linear, background 0.5s; width: 100%; }
  .timer-fill.warning { background: var(--neon-pink); box-shadow: 0 0 8px var(--neon-pink); }
  .timer-num { position: absolute; right: 0; top: 8px; font-family: 'Orbitron', sans-serif; font-size: 0.8rem; color: var(--neon-cyan); }

  .category-badge { display: inline-block; font-size: 0.65rem; letter-spacing: 0.2em; text-transform: uppercase; padding: 3px 10px; border: 1px solid var(--neon-yellow); color: var(--neon-yellow); margin-bottom: 12px; border-radius: 2px; }
  .question-text { font-size: 1rem; line-height: 1.6; margin-bottom: 22px; color: rgba(255,255,255,0.9); min-height: 60px; }

  .options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .opt-btn { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.8); font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; padding: 14px 12px; cursor: pointer; transition: all 0.15s; border-radius: 3px; text-align: left; line-height: 1.4; }
  .opt-btn:hover:not(:disabled) { border-color: var(--neon-cyan); color: white; background: rgba(0,245,255,0.06); }
  .opt-btn.correct { border-color: var(--neon-green) !important; background: rgba(6,214,160,0.15) !important; color: var(--neon-green) !important; box-shadow: 0 0 15px rgba(6,214,160,0.2); }
  .opt-btn.wrong { border-color: var(--neon-pink) !important; background: rgba(255,0,110,0.15) !important; color: var(--neon-pink) !important; }
  .opt-btn:disabled { cursor: not-allowed; }

  .feedback { text-align: center; font-family: 'Orbitron', sans-serif; font-size: 0.8rem; letter-spacing: 0.2em; margin-top: 12px; height: 20px; }
  .feedback.correct { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }
  .feedback.wrong { color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); }

  /* Opponent answered indicator */
  .opp-status { font-size: 0.7rem; color: rgba(255,0,110,0.6); letter-spacing: 0.15em; text-align: center; margin-top: 6px; height: 16px; transition: opacity 0.3s; }
  .opp-status.visible { opacity: 1; }
  .opp-status.hidden { opacity: 0; }

  /* Results */
  .winner-banner { font-family: 'Orbitron', sans-serif; font-size: 1.4rem; font-weight: 900; text-align: center; margin-bottom: 20px; padding: 15px; border-radius: 4px; }
  .winner-banner.win { color: var(--neon-green); text-shadow: 0 0 20px var(--neon-green); border: 1px solid var(--neon-green); background: rgba(6,214,160,0.08); }
  .winner-banner.lose { color: var(--neon-pink); text-shadow: 0 0 20px var(--neon-pink); border: 1px solid var(--neon-pink); background: rgba(255,0,110,0.08); }
  .winner-banner.draw { color: var(--neon-yellow); text-shadow: 0 0 20px var(--neon-yellow); border: 1px solid var(--neon-yellow); background: rgba(255,190,11,0.08); }

  .stats-row { display: flex; justify-content: space-around; margin: 20px 0; padding: 20px; border: 1px solid var(--border); background: var(--panel); border-radius: 4px; }
  .stat { text-align: center; }
  .stat-val { font-family: 'Orbitron', sans-serif; font-size: 1.4rem; font-weight: 700; color: var(--neon-cyan); }
  .stat-label { font-size: 0.65rem; letter-spacing: 0.2em; color: rgba(255,255,255,0.4); text-transform: uppercase; margin-top: 4px; }

  .text-center { text-align: center; }
  .text-muted { color: rgba(255,255,255,0.35); font-size: 0.8rem; }
  .mt { margin-top: 16px; }
  .flex-row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }

  /* Connection status */
  .conn-status {
    position: fixed;
    top: 12px; right: 16px;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    z-index: 100;
    display: flex;
    align-items: center;
    gap: 6px;
    color: rgba(255,255,255,0.4);
  }
  .conn-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; }
  .conn-dot.connected { background: var(--neon-green); box-shadow: 0 0 6px var(--neon-green); }
  .conn-dot.disconnected { background: var(--neon-pink); }

  /* Disconnected overlay */
  .disconnected-notice {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(5,5,16,0.9);
    z-index: 200;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 20px;
    font-family: 'Orbitron', sans-serif;
    text-align: center;
  }
  .disconnected-notice.show { display: flex; }
  .disconnected-notice h2 { color: var(--neon-pink); text-shadow: 0 0 20px var(--neon-pink); font-size: 1.4rem; letter-spacing: 0.2em; }
  .disconnected-notice p { color: rgba(255,255,255,0.5); font-family: 'Share Tech Mono', monospace; font-size: 0.85rem; }
</style>
</head>
<body>

<div class="conn-status">
  <div class="conn-dot" id="conn-dot"></div>
  <span id="conn-label">OFFLINE</span>
</div>

<div class="disconnected-notice" id="disc-notice">
  <h2>‚ö° CONNESSIONE PERSA</h2>
  <p>L'avversario si √® disconnesso.</p>
  <button class="btn" onclick="goHome()">TORNA AL MENU</button>
</div>

<!-- HOME -->
<div class="screen active" id="screen-home">
  <div class="logo">QUIZ<span>ARENA</span></div>
  <div class="tagline">// multiplayer real-time knowledge battle //</div>
  <div class="panel">
    <div class="panel-title">// player setup</div>
    <input class="input-field" id="player-name" type="text" placeholder="inserisci il tuo nickname..." maxlength="20">
    <div class="panel-title mt">// scegli categoria</div>
    <div class="categories">
      <button class="cat-btn" data-cat="Storia" style="--cat-color:#ffbe0b" onclick="selectCat(this)"><span class="cat-icon">üèõÔ∏è</span><span class="cat-name">Storia</span></button>
      <button class="cat-btn" data-cat="Scienza" style="--cat-color:#06d6a0" onclick="selectCat(this)"><span class="cat-icon">‚öóÔ∏è</span><span class="cat-name">Scienza</span></button>
      <button class="cat-btn" data-cat="Sport" style="--cat-color:#ff006e" onclick="selectCat(this)"><span class="cat-icon">‚öΩ</span><span class="cat-name">Sport</span></button>
      <button class="cat-btn" data-cat="Arte & Cinema" style="--cat-color:#00f5ff" onclick="selectCat(this)"><span class="cat-icon">üé¨</span><span class="cat-name">Arte & Cinema</span></button>
      <button class="cat-btn" data-cat="Tecnologia" style="--cat-color:#a855f7" onclick="selectCat(this)"><span class="cat-icon">üíª</span><span class="cat-name">Tecnologia</span></button>
      <button class="cat-btn" data-cat="Misto" style="--cat-color:#f97316" onclick="selectCat(this)"><span class="cat-icon">üé≤</span><span class="cat-name">Misto</span></button>
    </div>
    <div class="mt flex-row">
      <button class="btn" id="start-btn" onclick="joinSearch()" disabled>TROVA AVVERSARIO</button>
    </div>
  </div>
</div>

<!-- SEARCHING -->
<div class="screen" id="screen-search">
  <div class="logo logo-sm">QUIZ<span>ARENA</span></div>
  <div class="panel text-center">
    <div class="panel-title">// ricerca avversario in corso</div>
    <div class="waiting-anim"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div class="loading-text" id="search-status">SCANNING NETWORK...</div>
    <div class="text-muted mt" style="margin-top: 14px;">categoria: <span id="search-cat" style="color:var(--neon-cyan)"></span></div>
    <div class="mt"><button class="btn btn-pink" onclick="cancelSearch()" style="font-size:0.7rem; padding:10px 20px;">ANNULLA</button></div>
  </div>
</div>

<!-- VS -->
<div class="screen" id="screen-vs">
  <div class="logo logo-sm">QUIZ<span>ARENA</span></div>
  <div class="panel">
    <div class="panel-title text-center">// avversario trovato!</div>
    <div class="vs-container">
      <div class="player-card">
        <div class="player-avatar">üßë‚Äçüíª</div>
        <div class="player-name" id="vs-me">YOU</div>
      </div>
      <div class="vs-text">VS</div>
      <div class="player-card opponent">
        <div class="player-avatar">üëæ</div>
        <div class="player-name" id="vs-opp" style="color:var(--neon-pink)">---</div>
      </div>
    </div>
    <div class="text-center mt">
      <div class="loading-text" id="countdown-text">LA PARTITA STA PER INIZIARE...</div>
    </div>
  </div>
</div>

<!-- QUIZ -->
<div class="screen" id="screen-quiz">
  <div class="panel" style="max-width:640px; width:100%;">
    <div class="score-bar">
      <div class="score-box you">üßë <span id="my-score">0</span></div>
      <div class="q-counter">Q <span id="q-num">1</span>/10</div>
      <div class="score-box opp"><span id="opp-score">0</span> üëæ</div>
    </div>
    <div class="timer-wrap">
      <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>
      <div class="timer-num" id="timer-num">15</div>
    </div>
    <div class="category-badge" id="q-cat">---</div>
    <div class="question-text" id="question-text">...</div>
    <div class="options" id="options-grid"></div>
    <div class="feedback" id="feedback"></div>
    <div class="opp-status hidden" id="opp-status">üëæ L'AVVERSARIO HA RISPOSTO</div>
  </div>
</div>

<!-- RESULTS -->
<div class="screen" id="screen-results">
  <div class="logo logo-sm">QUIZ<span>ARENA</span></div>
  <div class="panel" style="max-width:560px; width:100%;">
    <div class="winner-banner" id="winner-banner">---</div>
    <div class="stats-row">
      <div class="stat"><div class="stat-val" id="res-my-score">0</div><div class="stat-label">I tuoi punti</div></div>
      <div class="stat"><div class="stat-val" id="res-opp-score" style="color:var(--neon-pink)">0</div><div class="stat-label">Avversario</div></div>
    </div>
  </div>
  <div class="flex-row mt">
    <button class="btn" onclick="goHome()">GIOCA ANCORA</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ WebSocket ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WS_URL = location.protocol === 'https:' 
  ? `wss://${location.host}` 
  : `ws://${location.host}`;
let ws = null;
let reconnectTimeout = null;

// ‚îÄ‚îÄ‚îÄ Stato ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const st = {
  name: '',
  category: '',
  myScore: 0,
  oppScore: 0,
  currentQ: 0,
  timer: null,
  timeLeft: 15,
  answered: false,
};

// ‚îÄ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function setConn(connected) {
  const dot = document.getElementById('conn-dot');
  const lbl = document.getElementById('conn-label');
  dot.className = 'conn-dot ' + (connected ? 'connected' : 'disconnected');
  lbl.textContent = connected ? 'ONLINE' : 'OFFLINE';
}

function selectCat(btn) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  st.category = btn.dataset.cat;
  checkStart();
}

function checkStart() {
  const name = document.getElementById('player-name').value.trim();
  document.getElementById('start-btn').disabled = !(name && st.category);
}
document.getElementById('player-name').addEventListener('input', checkStart);

// ‚îÄ‚îÄ‚îÄ Connessione WS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function connect(onReady) {
  if (ws && ws.readyState === WebSocket.OPEN) { onReady && onReady(); return; }

  ws = new WebSocket(WS_URL);

  ws.onopen = () => {
    setConn(true);
    onReady && onReady();
  };

  ws.onmessage = (e) => {
    let msg;
    try { msg = JSON.parse(e.data); } catch { return; }
    handleMessage(msg);
  };

  ws.onclose = () => {
    setConn(false);
    ws = null;
  };

  ws.onerror = () => {
    setConn(false);
  };
}

function send(obj) {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify(obj));
  }
}

// ‚îÄ‚îÄ‚îÄ Messaggi server ‚Üí client ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleMessage(msg) {
  switch (msg.type) {

    case 'connected':
      // Server ha confermato la connessione
      break;

    case 'searching':
      // Conferma che siamo in matchmaking
      animateSearching();
      break;

    case 'search_timeout':
      showScreen('screen-home');
      alert('Nessun avversario trovato. Riprova!');
      break;

    case 'match_found': {
      document.getElementById('vs-me').textContent = msg.you.name.toUpperCase();
      document.getElementById('vs-opp').textContent = msg.opponent.name.toUpperCase();
      showScreen('screen-vs');
      
      let cd = 3;
      const cdEl = document.getElementById('countdown-text');
      const iv = setInterval(() => {
        cd--;
        if (cd > 0) cdEl.textContent = `INIZIA IN ${cd}...`;
        else { clearInterval(iv); }
      }, 1000);
      break;
    }

    case 'question': {
      showScreen('screen-quiz');
      startQuestion(msg);
      break;
    }

    case 'answer_result': {
      onAnswerResult(msg);
      break;
    }

    case 'opponent_answered': {
      st.oppScore = msg.opponentScore;
      document.getElementById('opp-score').textContent = st.oppScore;
      const oppStatus = document.getElementById('opp-status');
      oppStatus.classList.remove('hidden');
      oppStatus.classList.add('visible');
      break;
    }

    case 'game_over': {
      showResults(msg);
      break;
    }

    case 'opponent_disconnected': {
      document.getElementById('disc-notice').classList.add('show');
      clearInterval(st.timer);
      break;
    }
  }
}

// ‚îÄ‚îÄ‚îÄ Flow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function joinSearch() {
  st.name = document.getElementById('player-name').value.trim() || 'PLAYER';
  st.myScore = 0;
  st.oppScore = 0;
  st.currentQ = 0;

  document.getElementById('search-cat').textContent = st.category;
  document.getElementById('search-status').textContent = 'CONNESSIONE IN CORSO...';
  showScreen('screen-search');

  connect(() => {
    send({ type: 'join', name: st.name, category: st.category });
  });
}

let searchAnim;
function animateSearching() {
  const msgs = ['SCANNING NETWORK...', 'SEARCHING OPPONENTS...', 'MATCHING PLAYERS...'];
  let i = 0;
  clearInterval(searchAnim);
  document.getElementById('search-status').textContent = msgs[0];
  searchAnim = setInterval(() => {
    i = (i + 1) % msgs.length;
    document.getElementById('search-status').textContent = msgs[i];
  }, 1800);
}

function cancelSearch() {
  clearInterval(searchAnim);
  send({ type: 'cancel_search' });
  showScreen('screen-home');
}

// ‚îÄ‚îÄ‚îÄ Domanda ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startQuestion(msg) {
  clearInterval(searchAnim);
  clearInterval(st.timer);
  st.answered = false;
  st.timeLeft = msg.timeLimit || 15;
  st.currentQ = msg.questionIndex;

  document.getElementById('q-num').textContent = msg.questionIndex + 1;
  document.getElementById('q-cat').textContent = msg.category;
  document.getElementById('question-text').textContent = msg.question;
  document.getElementById('my-score').textContent = st.myScore;
  document.getElementById('opp-score').textContent = st.oppScore;
  document.getElementById('feedback').textContent = '';
  document.getElementById('feedback').className = 'feedback';
  document.getElementById('opp-status').className = 'opp-status hidden';

  const grid = document.getElementById('options-grid');
  grid.innerHTML = '';
  msg.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'opt-btn';
    btn.textContent = opt;
    btn.onclick = () => submitAnswer(i);
    grid.appendChild(btn);
  });

  updateTimer();
  st.timer = setInterval(() => {
    st.timeLeft--;
    updateTimer();
    if (st.timeLeft <= 0) {
      clearInterval(st.timer);
      if (!st.answered) {
        disableOptions();
        showFeedback('‚è± TEMPO SCADUTO!', 'wrong');
      }
    }
  }, 1000);
}

function updateTimer() {
  const pct = (st.timeLeft / 15) * 100;
  const fill = document.getElementById('timer-fill');
  fill.style.width = pct + '%';
  document.getElementById('timer-num').textContent = st.timeLeft;
  if (st.timeLeft <= 5) fill.classList.add('warning');
  else fill.classList.remove('warning');
}

function submitAnswer(idx) {
  if (st.answered) return;
  st.answered = true;
  clearInterval(st.timer);
  disableOptions();
  send({ type: 'answer', answerIndex: idx });
}

function disableOptions() {
  document.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
}

function onAnswerResult(msg) {
  st.myScore = msg.yourScore;
  document.getElementById('my-score').textContent = st.myScore;

  const btns = document.querySelectorAll('.opt-btn');
  if (st.answered) {
    // Trova il bottone che l'utente aveva cliccato ‚Äî non sappiamo quale, ma possiamo
    // semplicemente colorare corretto/sbagliato sull'ultimo cliccato via state
  }
  btns[msg.correctIndex].classList.add('correct');

  if (msg.correct) {
    showFeedback(`‚úì CORRETTO! +${msg.points}`, 'correct');
  } else {
    showFeedback('‚úó SBAGLIATO!', 'wrong');
    // colora sbagliato: l'utente ha cliccato qualcosa di non corretto
    btns.forEach((b, i) => {
      if (i !== msg.correctIndex && b.disabled && !b.classList.contains('correct')) {
        b.classList.add('wrong');
      }
    });
  }
}

function showFeedback(msg, type) {
  const el = document.getElementById('feedback');
  el.textContent = msg;
  el.className = 'feedback ' + type;
}

// ‚îÄ‚îÄ‚îÄ Risultati ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showResults(msg) {
  clearInterval(st.timer);
  showScreen('screen-results');

  const banner = document.getElementById('winner-banner');
  if (msg.result === 'win') { banner.textContent = 'üèÜ VITTORIA!'; banner.className = 'winner-banner win'; }
  else if (msg.result === 'lose') { banner.textContent = 'üíÄ SCONFITTA'; banner.className = 'winner-banner lose'; }
  else { banner.textContent = '‚ö° PAREGGIO!'; banner.className = 'winner-banner draw'; }

  document.getElementById('res-my-score').textContent = msg.yourScore;
  document.getElementById('res-opp-score').textContent = msg.opponentScore;
}

function goHome() {
  document.getElementById('disc-notice').classList.remove('show');
  clearInterval(st.timer);
  clearInterval(searchAnim);
  showScreen('screen-home');
  // Pre-compila il nome se gi√† inserito
  if (st.name) document.getElementById('player-name').value = st.name;
  checkStart();
}

// Connetti subito all'avvio per avere la WS pronta
connect();
</script>
</body>
</html>
